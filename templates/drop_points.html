{% extends "base.html" %}

{% block title %}Drop Points | WasteWorks{% endblock %}

{% block head %}
<!-- OpenLayers CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
<style>
    #map {
        width: 100%;
        height: 500px;
        margin-bottom: 20px;
    }
    .drop-point-item {
        transition: all 0.2s ease;
    }
    .drop-point-item:hover {
        background-color: rgba(var(--bs-secondary-rgb), 0.15);
        cursor: pointer;
    }
    .material-tag {
        font-size: 0.7em;
        padding: 0.2em 0.4em;
        margin-right: 0.2em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="text-center mb-4">
        <h1 class="display-4">Waste Drop Points</h1>
        <p class="lead">Find nearby locations to drop off recyclable materials in Bangalore</p>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="card-title mb-0">Drop Points List</h5>
                </div>
                <div class="list-group list-group-flush" id="dropPointsList">
                    {% for point in drop_points %}
                    <div class="list-group-item drop-point-item" 
                         data-lat="{{ point.lat }}" 
                         data-lon="{{ point.lon }}"
                         data-name="{{ point.name }}"
                         data-address="{{ point.address }}">
                        <h6 class="mb-1">{{ point.name }}</h6>
                        <p class="mb-1 small text-muted">{{ point.address }}</p>
                        <div>
                            {% for type in point.types %}
                            <span class="badge bg-secondary material-tag">{{ type }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- OpenLayers JS -->
<script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the map
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([77.5946, 12.9716]), // Bangalore coordinates
                zoom: 12
            })
        });
        
        // Create vector source for markers
        const vectorSource = new ol.source.Vector();
        
        // Create vector layer for markers
        const vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/icons/geo-alt-fill.svg',
                    scale: 2
                })
            })
        });
        
        // Add vector layer to map
        map.addLayer(vectorLayer);
        
        // Add drop points to map
        const dropPoints = [
            {% for point in drop_points %}
            {
                name: "{{ point.name }}",
                address: "{{ point.address }}",
                lat: {{ point.lat }},
                lon: {{ point.lon }},
                types: [{% for type in point.types %}"{{ type }}"{% if not loop.last %}, {% endif %}{% endfor %}]
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Create features for each drop point
        dropPoints.forEach(point => {
            const feature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([point.lon, point.lat])),
                name: point.name,
                address: point.address,
                types: point.types
            });
            
            vectorSource.addFeature(feature);
        });
        
        // Add popup overlay
        const popupElement = document.createElement('div');
        popupElement.className = 'ol-popup card shadow-sm';
        popupElement.style.position = 'absolute';
        popupElement.style.backgroundColor = 'white';
        popupElement.style.padding = '15px';
        popupElement.style.borderRadius = '4px';
        popupElement.style.minWidth = '280px';
        popupElement.style.zIndex = '1000';
        
        const popup = new ol.Overlay({
            element: popupElement,
            positioning: 'bottom-center',
            stopEvent: false,
            offset: [0, -10]
        });
        map.addOverlay(popup);
        
        // Display popup on click
        map.on('click', (evt) => {
            const feature = map.forEachFeatureAtPixel(evt.pixel, (feature) => feature);
            
            if (feature) {
                const coordinate = feature.getGeometry().getCoordinates();
                popup.setPosition(coordinate);
                
                // Create popup content
                popupElement.innerHTML = `
                    <h5>${feature.get('name')}</h5>
                    <p>${feature.get('address')}</p>
                    <div>
                        ${feature.get('types').map(type => 
                            `<span class="badge bg-secondary material-tag">${type}</span>`
                        ).join(' ')}
                    </div>
                `;
                
                popupElement.style.display = 'block';
            } else {
                popupElement.style.display = 'none';
            }
        });
        
        // Handle list item clicks
        document.querySelectorAll('.drop-point-item').forEach(item => {
            item.addEventListener('click', () => {
                const lat = parseFloat(item.dataset.lat);
                const lon = parseFloat(item.dataset.lon);
                
                // Center map on selected point
                map.getView().animate({
                    center: ol.proj.fromLonLat([lon, lat]),
                    zoom: 15,
                    duration: 1000
                });
                
                // Show popup for the point
                popup.setPosition(ol.proj.fromLonLat([lon, lat]));
                popupElement.innerHTML = `
                    <h5>${item.dataset.name}</h5>
                    <p>${item.dataset.address}</p>
                    <div>
                        ${Array.from(item.querySelectorAll('.material-tag')).map(tag => 
                            tag.outerHTML
                        ).join('')}
                    </div>
                `;
                popupElement.style.display = 'block';
            });
        });
    });
</script>
{% endblock %}
